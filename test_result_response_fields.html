<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultå’ŒResponseå­—æ®µæ˜¾ç¤ºæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .btn { padding: 8px 16px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn:disabled { background-color: #6c757d; cursor: not-allowed; }
        .log { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; border-radius: 4px; white-space: pre-wrap; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .field-demo { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .field-title { font-weight: bold; color: #333; margin-bottom: 10px; }
        .field-content { background-color: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .valid-json { border-left: 4px solid #28a745; }
        .invalid-json { border-left: 4px solid #ffc107; }
        .no-data { border-left: 4px solid #6c757d; color: #6c757d; }
        .status-tag { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-warning { background-color: #fff3cd; color: #856404; }
        .status-info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Resultå’ŒResponseå­—æ®µæ˜¾ç¤ºæµ‹è¯•</h1>
        
        <div class="field-demo">
            <h3>ğŸ“‹ ç•Œé¢æ”¹è¿›æµ‹è¯•</h3>
            <p><strong>âœ¨ æ–°åŠŸèƒ½:</strong></p>
            <ul>
                <li>åˆå¹¶ResultçŠ¶æ€å’ŒResponseçŠ¶æ€ä¸ºå•ä¸€Resultåˆ—</li>
                <li>è‡ªåŠ¨æ£€æµ‹408 IOè¶…æ—¶é”™è¯¯ï¼Œæ˜¾ç¤ºç®€åŒ–ä¿¡æ¯</li>
                <li>JSONæ•°æ®è¶…è¿‡100å­—ç¬¦è‡ªåŠ¨æˆªå–</li>
                <li>é‡çˆ¬æŒ‰é’®ç§»è‡³æ“ä½œåˆ—</li>
                <li>ç‚¹å‡»æŸ¥çœ‹æŒ‰é’®å¯æŸ¥çœ‹å®Œæ•´JSONæ•°æ®</li>
            </ul>
            
            <p><strong>API:</strong> /api/statistics/details</p>
            <p><strong>ä»»åŠ¡ç±»å‹:</strong> GoogleSearchJob</p>
            <p><strong>è¯¦æƒ…ç±»å‹:</strong> failed (å¤±è´¥æ•°æ®)</p>
            <p><strong>ç§Ÿæˆ·:</strong> Anker</p>
            <p><strong>æ—¥æœŸ:</strong> 2025-06-04</p>
            <button class="btn btn-primary" onclick="testAPI()">ğŸ”„ æµ‹è¯•API</button>
            <button class="btn btn-success" onclick="clearLog()">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div id="console" class="log">
            <strong>æ§åˆ¶å°æ—¥å¿—:</strong><br>
            ç­‰å¾…æµ‹è¯•...
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        function log(message) {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            console.innerHTML += `[${timestamp}] ${message}\n`;
            console.scrollTop = console.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('console').innerHTML = '<strong>æ§åˆ¶å°æ—¥å¿—:</strong><br>å·²æ¸…ç©º...\n';
            document.getElementById('results').innerHTML = '';
        }

        async function testAPI() {
            log('ğŸ”„ å¼€å§‹æµ‹è¯•API...');
            
            try {
                const response = await fetch('/api/statistics/details', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        start_date: '2025-06-01',
                        end_date: '2025-06-04',
                        tenant_ids: ['Anker'],
                        task_type: 'GoogleSearchJob',
                        detail_type: 'failed',
                        date: '2025-06-04',
                        page: 1,
                        page_size: 5,
                        table: 'job_a'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`âœ… APIè°ƒç”¨æˆåŠŸï¼Œè·å–åˆ° ${result.data.details.length} æ¡è®°å½•`);
                    
                    displayResults(result.data.details);
                } else {
                    log(`âŒ APIè°ƒç”¨å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                log(`ğŸ’¥ ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
        }
        
        function displayResults(details) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h2>ğŸ“‹ è¡¨æ ¼ç•Œé¢æ¨¡æ‹Ÿ</h2>';
            
            details.forEach((record, index) => {
                const recordDiv = document.createElement('div');
                recordDiv.className = 'field-demo';
                
                // æ¨¡æ‹Ÿå‰ç«¯çš„Resultæ˜¾ç¤ºé€»è¾‘
                const resultDisplay = formatResultDisplay(record);
                
                recordDiv.innerHTML = `
                    <h3>è®°å½• ${index + 1}</h3>
                    <div><strong>è¯·æ±‚SSN:</strong> ${record.req_ssn}</div>
                    <div><strong>çŠ¶æ€:</strong> <span class="status-tag status-warning">${record.status}</span></div>
                    <div><strong>Task ID:</strong> ${record.ext_ssn}</div>
                    <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${record.created_at}</div>
                    
                    <div class="field-demo valid-json">
                        <div class="field-title">ğŸ“Š è¡¨æ ¼Resultåˆ—æ˜¾ç¤º</div>
                        <div class="field-content" style="font-family: Monaco, monospace; background-color: #e8f5e8;">${resultDisplay}</div>
                    </div>
                    
                    <div><strong>é‡çˆ¬æŒ‰é’®:</strong> ${record.show_recrawl_button ? 'âœ… åœ¨æ“ä½œåˆ—æ˜¾ç¤º' : 'âŒ ä¸æ˜¾ç¤º'}</div>
                    
                    <div class="field-demo ${getFieldClass(record.result)}">
                        <div class="field-title">ğŸ”§ Resultå­—æ®µ (å®Œæ•´æ•°æ®)</div>
                        ${formatFieldDisplay(record.result, 'Result')}
                    </div>
                    
                    <div class="field-demo ${getFieldClass(record.response)}">
                        <div class="field-title">ğŸ“¡ Responseå­—æ®µ (å®Œæ•´æ•°æ®)</div>
                        ${formatFieldDisplay(record.response, 'Response')}
                    </div>
                `;
                
                resultsDiv.appendChild(recordDiv);
            });
        }
        
        // æ¨¡æ‹Ÿå‰ç«¯çš„formatResultDisplayæ–¹æ³•
        function formatResultDisplay(row) {
            // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®Šçš„408 IOè¶…æ—¶é”™è¯¯
            if (row.status === 'FAILED' && row.result && row.result.raw) {
                try {
                    const resultData = typeof row.result.raw === 'string' 
                        ? JSON.parse(row.result.raw) 
                        : row.result.raw;
                    
                    if (resultData && resultData.E3001) {
                        const errorMsg = resultData.E3001;
                        if (errorMsg.includes('408 IORuntimeException - SocketTimeoutException: connect timed out')) {
                            return '408 IOè¶…æ—¶';
                        }
                    }
                } catch (error) {
                    // JSONè§£æå¤±è´¥ï¼Œç»§ç»­åç»­å¤„ç†
                }
            }
            
            // å°è¯•æ˜¾ç¤ºResultæ•°æ®
            if (row.result && row.result.raw) {
                const resultText = row.result.is_valid_json ? row.result.formatted : row.result.raw;
                // å¦‚æœå†…å®¹å¤ªé•¿ï¼Œæˆªå–å‰100ä¸ªå­—ç¬¦
                if (resultText.length > 100) {
                    return resultText.substring(0, 100) + '...';
                }
                return resultText;
            }
            
            // å¦‚æœæ²¡æœ‰Resultæ•°æ®ï¼Œå°è¯•æ˜¾ç¤ºResponseæ•°æ®
            if (row.response && row.response.raw) {
                const responseText = row.response.is_valid_json ? row.response.formatted : row.response.raw;
                // å¦‚æœå†…å®¹å¤ªé•¿ï¼Œæˆªå–å‰100ä¸ªå­—ç¬¦
                if (responseText.length > 100) {
                    return responseText.substring(0, 100) + '...';
                }
                return responseText;
            }
            
            return 'æ— æ•°æ®';
        }
        
        function getFieldClass(field) {
            if (!field || !field.raw) return 'no-data';
            return field.is_valid_json ? 'valid-json' : 'invalid-json';
        }
        
        function formatFieldDisplay(field, fieldName) {
            if (!field || !field.raw) {
                return `<div class="field-content">æ—  ${fieldName} æ•°æ®</div>`;
            }
            
            const statusTag = field.is_valid_json 
                ? '<span class="status-tag status-success">æœ‰æ•ˆJSON</span>'
                : '<span class="status-tag status-warning">æ ¼å¼é”™è¯¯</span>';
            
            return `
                <div><strong>çŠ¶æ€:</strong> ${statusTag}</div>
                ${field.error ? `<div><strong>é”™è¯¯:</strong> ${field.error}</div>` : ''}
                <div><strong>åŸå§‹æ•°æ®:</strong></div>
                <div class="field-content">${field.raw}</div>
                ${field.is_valid_json ? `
                    <div><strong>æ ¼å¼åŒ–æ•°æ®:</strong></div>
                    <div class="field-content">${field.formatted}</div>
                ` : ''}
            `;
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼ŒResultå’ŒResponseå­—æ®µæµ‹è¯•å·²å°±ç»ª');
        });
    </script>
</body>
</html> 